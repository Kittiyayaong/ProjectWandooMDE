### Advanced Huntingì´ë€? 
ì¿¼ë¦¬ ê¸°ë°˜ ìœ„í˜‘ ê²€ìƒ‰ë„êµ¬ë¡œ, ë„¤íŠ¸ì›Œí¬ì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ íƒìƒ‰í•˜ê³  ìœ„í˜‘ ì§€í‘œì™€ ì—”í‹°í‹°ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìµœëŒ€ 30ì¼ ë™ì•ˆì˜ ì›ì‹œ ë°ì´í„°ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê¸°ëŠ¥ì´ ì•„ë‹ˆê¸° ë–„ë¬¸ì— ì‚¬ìš©ìê°€ í•„ìš”í•  ë•Œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì—¬ ì¶”ê°€ì ì¸ ì •ë³´ë¥¼ íƒìƒ‰í•˜ê³  ë¶„ì„ì— ì‚¬ìš©ë©ë‹ˆë‹¤. 

1. Advanced Huntingì˜ ì£¼ìš” ê¸°ëŠ¥
* ë°ì´í„° íƒìƒ‰: ìµœëŒ€ 30ì¼ ë™ì•ˆì˜ ì›ì‹œ ë°ì´í„°ë¥¼ íƒìƒ‰í•˜ì—¬ ìœ„í˜‘ ì§€í‘œì™€ ì—”í‹°í‹°ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.
* ìœ ì—°í•œ ë°ì´í„° ì ‘ê·¼: ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ì™€ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìœ¼ë©°, Kusto Query Language (KQL)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* íƒì§€ ê·œì¹™ ìƒì„±: Advanced Hunting ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íƒì§€ ê·œì¹™ì„ ìƒì„±í•˜ê³ , ì´ë¥¼ í†µí•´ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ëŒ€ì‘ ì¡°ì¹˜ë¥¼ ì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

2. Advanced Hunting í™œìš© 
ì˜ˆì‹œ: MDEë¥¼ ì‚¬ìš©í•˜ëŠ” ê³ ê°ì´ EDR, EDR in Block Mode, Advanced Huntingì„ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì— ë°”ì´ëŸ¬ìŠ¤ê°€ ì¹¨íˆ¬

* ë°”ì´ëŸ¬ìŠ¤ ì¹¨íˆ¬: ì•…ì„± íŒŒì¼ì´ ì‹œìŠ¤í…œì— ì¹¨íˆ¬í•˜ì—¬ ì‹¤í–‰ë©ë‹ˆë‹¤.
* EDR íƒì§€: EDRì´ ì•…ì„± íŒŒì¼ì˜ ì‹¤í–‰ì„ íƒì§€í•˜ê³ , ì´ë¥¼ ë³´ê³ í•©ë‹ˆë‹¤.
* Advanced Hunting ë¶„ì„: ë³´ì•ˆ íŒ€ì€ Advanced Huntingì„ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ì ì¸ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë°”ì´ëŸ¬ìŠ¤ê°€ ì–´ë–»ê²Œ ì‹œìŠ¤í…œì— ì¹¨íˆ¬í–ˆëŠ”ì§€, ìœ ì‚¬í•œ ìœ„í˜‘ì´ ë‹¤ë¥¸ ì‹œìŠ¤í…œì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤

3. Advanced Hunting ì¿¼ë¦¬ ì‘ì„± ë°©ë²•
Advanced Huntingì€ Kusto Query Language (KQL)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, ì´ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ì´ë²¤íŠ¸ë¥¼ íƒìƒ‰í•˜ê³  ìœ„í˜‘ ì§€í‘œì™€ ì—”í‹°í‹°ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

4. ì¿¼ë¦¬ ì‘ì„±ì˜ ê¸°ë³¸ ë‹¨ê³„
* í…Œì´ë¸” ì„ íƒ: ì¿¼ë¦¬ëŠ” ì¼ë°˜ì ìœ¼ë¡œ í…Œì´ë¸” ì´ë¦„ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,Â DeviceProcessEventsÂ í…Œì´ë¸”ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì‹œê°„ ë²”ìœ„ ì„¤ì •: ì¿¼ë¦¬ì˜ ì²« ë²ˆì§¸ ìš”ì†ŒëŠ” ì‹œê°„ í•„í„°ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì§€ë‚œ 7ì¼ ë™ì•ˆì˜ ë°ì´í„°ë¥¼ íƒìƒ‰í•˜ë ¤ë©´Â | where Timestamp > ago(7d)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì¡°ê±´ ì¶”ê°€: íŠ¹ì • ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ ë°ì´í„°ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, PowerShell ì‹¤í–‰ ì´ë²¤íŠ¸ë¥¼ ì°¾ìœ¼ë ¤ë©´Â | where FileName in~ ("powershell.exe", "powershell_ise.exe")ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ê²°ê³¼ ì •ë ¬ ë° í‘œì‹œ: ê²°ê³¼ë¥¼ ì •ë ¬í•˜ê³  í‘œì‹œí•  ì—´ì„ ì„ íƒí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,Â | project Timestamp, DeviceName, FileName, ProcessCommandLineë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
* ê³ ê°ì‚¬ Needs: ìµœê·¼ 30ì¼ ë™ì•ˆ ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤ ê°ì§€ê°€ 2íšŒ ì´ìƒ ë°œìƒí•œ ì¥ì¹˜ë“¤ì„ í™•ì¸ 
* ì„¤ì • ë°©í–¥: Advanced huntingì„ í†µí•´ ì¶”ê°€ì ì¸ ë‚´ìš©ì„ ì¿¼ë¦¬ë¥¼ í†µí•´ ìˆ˜ë™ ê²€ìƒ‰í•œë‹¤.

### âœ… Advanced Hunting Query test
1. ìœ„ì¹˜: MDE console > Hunting > Advanced Hunting 

![image](https://github.com/user-attachments/assets/ed915a13-de31-465f-8278-803b882bf850)

2. ì‹œë‚˜ë¦¬ì˜¤ 1. PowerShell ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸ íƒì§€

```powershell
DeviceProcessEvents 
| where Timestamp > ago(7d)
| where FileName in~ ("powershell.exe", "powershell_ise.exe") 
| where ProcessCommandLine has_any("WebClient", "DownloadFile", "DownloadData", "DownloadString", "WebRequest", "Shellcode", "http", "https") 
| project Timestamp, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, FileName, ProcessCommandLine, RemoteIP, RemoteUrl, RemotePort, RemoteIPType 
| top 100 by Timestamp
![image](https://github.com/user-attachments/assets/b87a7bed-d82f-4892-a4f6-5a71fcb36d57)
```

* DvcipCrProcessEvents: ì´ ì¿¼ë¦¬ëŠ”Â DvcipCrProcessEventsÂ í…Œì´ë¸”ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
* where Timestamp > ago(7d): ì§€ë‚œ 7ì¼ ë™ì•ˆì˜ ë°ì´í„°ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
* where FileName in~('powershell.exe', 'powershell_ise.exe'):Â powershell.exeÂ ë˜ëŠ”Â powershell_ise.exeÂ íŒŒì¼ì´ ì‹¤í–‰ëœ ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
* where ProcessCommandLine has_any ~ : í”„ë¡œì„¸ìŠ¤ ëª…ë ¹ì¤„ì— "WebClient", "DownloadFile", "DownloadData", "DownloadString", "WebRequest", "Shellcode", "http", "https" ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ëœ ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
* project Timestamp~: ê²°ê³¼ì—ì„œÂ Timestamp,Â DeviceName,Â InitiatingProcessFileName,Â InitiatingProcessCommandLine,Â FileName,Â ProcessCommandLine,Â RemoteIp,Â RemoteUrl,Â RemotePort,Â RemoteIPTypeÂ ì—´ì„ ì„ íƒí•©ë‹ˆë‹¤.
* top 100 by Timestamp:Â TimestampÂ ê¸°ì¤€ìœ¼ë¡œ ìƒìœ„ 100ê°œì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

3. ì‹œë‚˜ë¦¬ì˜¤ 2. ìµœê·¼ 30ì¼ ë™ì•ˆ ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤ ê°ì§€ê°€ 2íšŒ ì´ìƒ ë°œìƒí•œ ì¥ì¹˜ë“¤ì„ í™•ì¸

```powershell
DeviceEvents 
| where Timestamp > ago(30d) 
| where ActionType == "AntivirusDetectionâ€œ
| summarize (Timestamp, ReportId)=arg_max(Timestamp, ReportId), count() by DeviceId, DeviceName 
| where count_ > 2
![image](https://github.com/user-attachments/assets/3887d19c-c39d-46d3-94e7-907de116cf43)
```
* DeviceEvents í…Œì´ë¸”ì—ì„œ Timestampê°€ ìµœê·¼ 30ì¼ ì´ë‚´ì¸ ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
* ActionTypeì´ "AntivirusDetection"ì¸ ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
* DeviceIdì™€ DeviceNameë³„ë¡œ ì´ë²¤íŠ¸ë¥¼ ê·¸ë£¹í™”í•˜ê³ , ê° ê·¸ë£¹ì—ì„œ ê°€ì¥ ìµœê·¼ì˜ Timestampì™€ ReportIdë¥¼ ì„ íƒí•˜ê³ , ì´ë²¤íŠ¸ ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
* ì´ë²¤íŠ¸ ìˆ˜ê°€ 2ê°œë¥¼ ì´ˆê³¼í•˜ëŠ” ê·¸ë£¹ë§Œ ì„ íƒí•©ë‹ˆë‹¤.

### âœ… Advanced hunting detection rule 
1. Detection ruleì´ë€?
Detection ruleì€ ë³´ì•ˆ ì‹œìŠ¤í…œì—ì„œ íŠ¹ì • ì´ë²¤íŠ¸ë‚˜ í™œë™ì„ ê°ì§€í•˜ê³  ê²½ê³ ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ì„¤ì •í•˜ëŠ” ê·œì¹™ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ê·œì¹™ì€ ë³´ì•ˆ ìœ„í˜‘ì„ ì¡°ê¸°ì— ë°œê²¬í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.

![image](https://github.com/user-attachments/assets/bf1dff3c-34e7-4753-a8bd-d8c68a687d25)

![image](https://github.com/user-attachments/assets/43b744e5-fb59-4e56-a22e-603000a2608e)

2. Category
Detection Rulesì˜ íŠ¹ì • ìœ í˜•ì˜ ë³´ì•ˆ ì´ë²¤íŠ¸

![image](https://github.com/user-attachments/assets/2fea3c68-c5b2-4a50-83d9-7ed533b65867)

3. Threat analytics report (Optional)

![image](https://github.com/user-attachments/assets/0d71d266-19ad-4e61-890d-b5ea89a6bd34)

4. Impacted entities
   
ê°ì§€ëœ ì´ë²¤íŠ¸ê°€ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì¥ì¹˜ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ ê°ì§€ëœ ì´ë²¤íŠ¸ê°€ ì–´ë–¤ ì¥ì¹˜ì™€ ê´€ë ¨ì´ ìˆëŠ”ì§€ë¥¼ ëª…í™•íˆ í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤. Device nameÂ ì—´ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¥ì¹˜ ì´ë¦„ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.Â 

![image](https://github.com/user-attachments/assets/cfe3ef00-01b1-4e50-85ad-576e38376118)

5.  Actions: 
ì¿¼ë¦¬ì—ì„œ ë°œê²¬ëœ ì—”í„°í‹°ì— ëŒ€í•´ ì ìš©í•  ìˆ˜ ìˆëŠ” ì¡°ì¹˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ ê°ì§€ëœ ìœ„í˜‘ì— ëŒ€í•´ ìë™ìœ¼ë¡œ ì·¨í•  ì¡°ì¹˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
* Collect investigation package: ì¡°ì‚¬ íŒ¨í‚¤ì§€ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ì¥ì¹˜ì—ì„œ ì¶”ê°€ì ì¸ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ì‹¬ì¸µ ë¶„ì„ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* Run antivirus scan: ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ê°ì—¼ëœ ì¥ì¹˜ì—ì„œ ì•…ì„± ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ íƒì§€í•˜ê³  ì œê±°í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
* Isolate device: ì¥ì¹˜ë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤. ê°ì—¼ëœ ì¥ì¹˜ê°€ ë„¤íŠ¸ì›Œí¬ì—ì„œ ë‹¤ë¥¸ ì¥ì¹˜ë¡œ ìœ„í˜‘ì„ ì „íŒŒí•˜ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
* Initiate investigation: ì¡°ì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ê°ì§€ëœ ìœ„í˜‘ì— ëŒ€í•´ ì‹¬ì¸µ ì¡°ì‚¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* Restrict app execution: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì„ ì œí•œí•©ë‹ˆë‹¤. ê°ì—¼ëœ ì¥ì¹˜ì—ì„œ íŠ¹ì • ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹¤í–‰ì„ ì œí•œí•˜ì—¬ ì¶”ê°€ì ì¸ ìœ„í˜‘ì„ ë°©ì§€í•©ë‹ˆë‹¤.

![image](https://github.com/user-attachments/assets/2dcadf1a-a0e8-46c5-80da-4657cd83b909)

6. Scope: demo group ì„ íƒ
ê²½ê³ ë¥¼ ì ìš©í•  ëŒ€ìƒì„ ì„¤ì •í•©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ ê°ì§€ ê·œì¹™ì´ ì ìš©ë  ì¥ì¹˜ë‚˜ ì¥ì¹˜ ê·¸ë£¹ì„ ì •ì˜í•©ë‹ˆë‹¤.
* All devices: ëª¨ë“  ì¥ì¹˜ì— ê²½ê³ ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
* Specific device groups: íŠ¹ì • ì¥ì¹˜ ê·¸ë£¹ì—ë§Œ ê²½ê³ ë¥¼ ì ìš©í•©ë‹ˆë‹¤

![image](https://github.com/user-attachments/assets/d398b9de-1e42-4a2e-a9f6-dbd6d5e5a39b)

7. ì„¤ì • ì™„ë£Œ
MDE console > Hunting > Custom detection rulesì—ì„œ ìƒì„±ëœ rule í™•ì¸

![image](https://github.com/user-attachments/assets/d37b7452-3423-4971-b531-f8d461ddb357)


### ğŸ”— [ë‹¤ìŒ Labìœ¼ë¡œ ì´ë™í•˜ê¸° Â»](https://github.com/Kittiyayaong/ProjectWandooMDE/blob/main/MDE%20Module04%20-%20EDR-03.%20Live%20Resonse.md)
